<div id="bulk_keywords_list" data-bulk-generation-target="keywordsContainer">
  <% keywords = domains.flat_map(&:keywords) %>
  <% if keywords.any? %>
    <div class="bg-[#0F172A]/50 border border-yellow-500/20 rounded-lg p-4 max-h-[600px] overflow-y-auto">
      <div class="flex items-center justify-between mb-3">
        <div class="flex items-center">
          <input type="checkbox" id="select_all" data-bulk-generation-target="selectAll" class="h-4 w-4 text-yellow-500 focus:ring-yellow-500 border-gray-300 rounded mr-2" data-action="change->bulk-generation#toggleSelectAll" />
          <label for="select_all" class="text-sm text-gray-300">Select All Keywords</label>
        </div>
        <span class="text-xs text-gray-400" id="keyword-count"><%= pluralize(keywords.count, 'keyword') %> available</span>
      </div>

      <!-- Search Keywords -->
      <div class="mb-4">
        <div class="relative">
          <input type="text" 
                 id="keyword-search" 
                 placeholder="Search keywords..." 
                 class="block w-full px-4 py-2 pl-10 rounded-lg bg-[#0F172A]/70 border border-yellow-500/30 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all duration-200 text-sm"
                 data-action="input->keyword-filter#filter" />
          <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="search" class="lucide lucide-search h-4 w-4 text-gray-400"><path d="m21 21-4.34-4.34"></path><circle cx="11" cy="11" r="8"></circle></svg>
          </div>
        </div>
      </div>

      <!-- Domain-level selection checkboxes -->
      <%# unless keywords.group_by(&:domain).size <= 1 %>
        <div class="mb-4 p-3 bg-yellow-500/5 border border-yellow-500/20 rounded">
          <p class="text-xs text-yellow-300 font-medium mb-2">Quick select by domain:</p>
          <div class="flex flex-wrap gap-2">
            <% domains.select { |domain| domain.keywords.any? }.each do |domain| %>
              <label class="flex items-center px-3 py-1 bg-yellow-500/10 border border-yellow-500/30 rounded text-xs text-yellow-300 hover:bg-yellow-500/20 cursor-pointer transition-colors">
                <input type="checkbox" 
                       data-domain="<%= domain.id %>" 
                       data-action="change->bulk-generation#toggleDomain"
                       class="h-3 w-3 text-yellow-500 focus:ring-yellow-500 border-gray-300 rounded mr-2" />
                <i data-lucide="globe" class="h-3 w-3 mr-1"></i>
                <%= domain.name %> (<%= domain.keywords.size %>)
              </label>
            <% end %>
          </div>
        </div>
      <%# end %>

      <% domains.select { |domain| domain.keywords.any? }.each do |domain| %>
        <div class="mb-6" data-domain-container="<%= domain.id %>">
          <div class="flex items-center mb-3 pb-2 border-b border-gray-600/30">
            <i data-lucide="globe" class="h-4 w-4 text-purple-400 mr-2"></i>
            <span class="text-sm font-medium text-purple-300"><%= domain.name %></span>
            <span class="ml-2 px-2 py-0.5 bg-purple-500/20 border border-purple-500/30 rounded text-xs text-purple-400" data-domain-count="<%= domain.id %>">
              <%= pluralize(domain.keywords.size, 'keyword') %>
            </span>
          </div>
          
          <% domain.keywords.each do |keyword| %>
            <div class="mb-4 bg-[#1E293B]/50 border border-gray-600/30 rounded-lg p-3" 
                 data-keyword-item 
                 data-keyword-name="<%= keyword.name.downcase %>" 
                 data-keyword-domain="<%= domain.id %>"
                 data-keyword-intent="<%= keyword.search_intent&.downcase || 'informational' %>">
              <!-- Main Keyword Row -->
              <div class="flex items-center justify-between">
                <div class="flex items-center flex-1">
                  <% 
                    is_checked = defined?(@selected_keyword_ids) && @selected_keyword_ids&.include?(keyword.id)
                    is_checked ||= local_assigns[:selected_keyword_ids]&.include?(keyword.id)
                  %>
                  <input type="checkbox" 
                         name="keyword_ids[]" 
                         value="<%= keyword.id %>" 
                         id="kw_<%= keyword.id %>" 
                         data-domain-id="<%= domain.id %>"
                         class="h-4 w-4 text-yellow-500 focus:ring-yellow-500 border-gray-300 rounded mr-3" 
                         data-action="change->bulk-generation#toggleKeyword" 
                         <%= 'checked' if is_checked %> />
                  <label for="kw_<%= keyword.id %>" class="text-sm font-medium text-gray-100 flex-1">
                    <i data-lucide="key" class="h-4 w-4 inline mr-1 text-yellow-400"></i>
                    <%= keyword.name %>
                  </label>
                  <div class="flex space-x-1 ml-2">
                    <% if keyword.is_long_tail %>
                      <span class="px-2 py-0.5 bg-green-500/20 border border-green-500/30 rounded text-xs text-green-400">Long Tail</span>
                    <% end %>
                    <% case keyword.search_intent %>
                    <% when 'commercial' %>
                      <span class="px-2 py-0.5 bg-yellow-500/20 border border-yellow-500/30 rounded text-xs text-yellow-400">Commercial</span>
                    <% when 'transactional' %>
                      <span class="px-2 py-0.5 bg-red-500/20 border border-red-500/30 rounded text-xs text-red-400">Transactional</span>
                    <% when 'navigational' %>
                      <span class="px-2 py-0.5 bg-blue-500/20 border border-blue-500/30 rounded text-xs text-blue-400">Navigational</span>
                    <% else %>
                      <span class="px-2 py-0.5 bg-gray-500/20 border border-gray-500/30 rounded text-xs text-gray-400">Informational</span>
                    <% end %>
                  </div>
                </div>
                
                <!-- Long Tail Generation Button -->
                <div class="ml-4">
                  <% has_long_tail = keyword.children.any? { |child| child.is_long_tail } %>
                  <%= link_to generate_long_tail_keywords_app_bulk_wordpress_content_generations_path(keyword_id: keyword.id),
                      data: { 
                        turbo_method: :post,
                        turbo_frame: "long_tail_#{keyword.id}"
                      },
                      class: "px-3 py-1.5 bg-gradient-to-r from-yellow-500 to-red-500 hover:from-yellow-600 hover:to-red-600 text-white rounded text-xs font-medium transition-all duration-200 inline-flex items-center shadow-sm hover:shadow-md" do %>
                    <% if has_long_tail %>
                      <i data-lucide="refresh-cw" class="h-3 w-3 mr-1"></i>
                      Refresh Long Tail (<%= keyword.children.count { |child| child.is_long_tail } %>)
                    <% else %>
                      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="zap" class="lucide lucide-zap h-3 w-3 mr-1"><path d="M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z"></path></svg>
                      Generate Long Tail
                    <% end %>
                  <% end %>
                </div>
              </div>

              <!-- Long Tail Keywords Container -->
              <%= turbo_frame_tag "long_tail_#{keyword.id}", class: "mt-3" do %>
                <!-- Show existing long tail keywords if they exist -->
                <% long_tail_children = keyword.children.select { |child| child.is_long_tail } %>
                <% if long_tail_children.any? %>
                  <%= render "long_tail_keywords", 
                      pillar_keyword: keyword, 
                      long_tail_keywords: long_tail_children,
                      loading: false,
                      error: nil %>
                <% end %>
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  <% elsif domains.any? %>
    <!-- Loading state when domains exist but keywords are still being discovered -->
    <div class="bg-[#0F172A]/50 border border-yellow-500/20 rounded-lg p-8 text-center">
      <div class="relative mx-auto mb-4 w-12 h-12">
        <!-- Spinning loader animation -->
        <div class="absolute inset-0 border-4 border-yellow-500/20 rounded-full"></div>
        <div class="absolute inset-0 border-4 border-transparent border-t-yellow-500 rounded-full animate-spin"></div>
        <i data-lucide="search" class="h-6 w-6 text-yellow-400 absolute inset-0 m-auto"></i>
      </div>
      <h3 class="text-lg font-medium text-yellow-400 mb-2 animate-pulse">Discovering Keywords...</h3>
      <p class="text-gray-400 text-sm mb-4">We're analyzing your domains to find the best SEO keywords for content generation.</p>
      <div class="space-y-2 text-xs text-blue-300">
        <p>üîç Scanning domain content and competitor analysis</p>
        <p>üìä Identifying high-value keyword opportunities</p>
        <p>‚è±Ô∏è This process typically takes few seconds</p>
      </div>

    </div>
  <% else %>
    <!-- No domains added yet -->
    <div class="bg-[#0F172A]/50 border border-yellow-500/20 rounded-lg p-8 text-center">
      <i data-lucide="search" class="h-12 w-12 text-yellow-400 mx-auto mb-4"></i>
      <h3 class="text-lg font-medium text-gray-100 mb-2">No Keywords Found</h3>
      <p class="text-gray-400 text-sm mb-4">Add domains to automatically discover keywords for content generation.</p>
      <div class="space-y-2 text-xs text-blue-300">
        <p>üí° Keywords are discovered automatically when you add domains</p>
      </div>
    </div>
  <% end %>
</div>

<script>
// Initialize Lucide icons
if (window.lucide) lucide.createIcons();

// Re-initialize Lucide icons after Turbo updates
document.addEventListener('turbo:frame-load', function() {
  if (window.lucide) {
    lucide.createIcons();
  }
});
</script> 