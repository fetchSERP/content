<div class="min-h-screen bg-[#0F172A]">
  <main>
    <section class="py-8 sm:py-12 bg-[#0F172A] text-white relative overflow-hidden">
      <div class="container mx-auto px-4 relative">
        <div class="max-w-7xl mx-auto">
          
          <!-- Header -->
          <div class="mb-8">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-4">
                <%= link_to app_keywords_path, 
                    class: "flex items-center justify-center w-10 h-10 bg-gray-700/50 hover:bg-gray-600/50 border border-gray-600/50 rounded-lg transition-colors" do %>
                  <i data-lucide="arrow-left" class="h-4 w-4 text-gray-400"></i>
                <% end %>
                <div>
                  <h1 class="font-bold text-3xl text-gray-100">Bulk WordPress Generation</h1>
                  <p class="text-gray-400 mt-1">Select keywords to generate WordPress content in bulk</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Flash Messages -->
          <% if flash[:alert] || flash[:notice] %>
            <div class="mb-6">
              <% if flash[:alert] %>
                <div class="p-4 bg-red-500/10 border border-red-500/30 rounded-lg text-red-400 mb-4">
                  <div class="flex items-center">
                    <i data-lucide="alert-circle" class="h-4 w-4 mr-2 flex-shrink-0"></i>
                    <%= flash[:alert] %>
                  </div>
                </div>
              <% end %>
              
              <% if flash[:notice] %>
                <div class="p-4 bg-green-500/10 border border-green-500/30 rounded-lg text-green-400">
                  <div class="flex items-center">
                    <i data-lucide="check-circle" class="h-4 w-4 mr-2 flex-shrink-0"></i>
                    <%= flash[:notice] %>
                  </div>
                </div>
              <% end %>
            </div>
          <% end %>

          <!-- Main Content -->
          <%= form_with url: app_bulk_wordpress_content_generations_path, method: :post, class: "space-y-8", data: { controller: "bulk-generation keyword-filter" } do |f| %>
            <div class="max-w-7xl mx-auto space-y-6">

              
              <!-- Keywords Selection -->
              <div class="bg-[#1E293B]/80 backdrop-blur-sm border border-yellow-500/20 rounded-xl shadow-[0_0_30px_rgba(234,179,8,0.1)] overflow-hidden">
                <div class="bg-gradient-to-r from-yellow-500/10 via-orange-500/10 to-red-500/10 border-b border-yellow-500/20 px-6 py-4">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center">
                      <div class="flex items-center justify-center w-8 h-8 bg-yellow-500/20 border border-yellow-500/30 rounded-lg mr-3">
                        <i data-lucide="key" class="h-4 w-4 text-yellow-400"></i>
                      </div>
                      <div>
                        <h2 class="text-lg font-semibold text-gray-100">Keywords to Generate Content For</h2>
                        <p class="text-sm text-gray-400">Select the keywords you want to generate content for</p>
                      </div>
                    </div>
                    <div class="flex space-x-2">
                      <%= link_to new_app_domain_path, 
                          class: "text-sm text-yellow-400 hover:text-yellow-300 transition-colors",
                          data: { turbo_frame: "bulk_keyword_domain_form" } do %>
                        <i data-lucide="plus" class="h-4 w-4 inline mr-1"></i>
                        Add Domain
                      <% end %>
                    </div>
                  </div>
                </div>

                <div class="p-6">
                  <!-- Turbo Frame for domain creation in keyword section -->
                  <%= turbo_frame_tag "bulk_keyword_domain_form" do %>
                    <!-- This will be replaced when creating domains -->
                  <% end %>

                  <%= render "keywords_list", domains: @domains %>
                  <p class="mt-4 text-sm text-gray-400">Keywords are organized by domain and show search intent.</p>
                </div>
              </div>
              
              <!-- Content Settings -->
              <div class="bg-[#1E293B]/80 backdrop-blur-sm border border-yellow-500/20 rounded-xl shadow-[0_0_30px_rgba(234,179,8,0.1)] overflow-hidden">
                <div class="bg-gradient-to-r from-yellow-500/10 via-orange-500/10 to-red-500/10 border-b border-yellow-500/20 px-6 py-4">
                  <div class="flex items-center justify-between">
                    <div class="flex items-center">
                      <div class="flex items-center justify-center w-8 h-8 bg-yellow-500/20 border border-yellow-500/30 rounded-lg mr-3">
                        <i data-lucide="settings" class="h-4 w-4 text-yellow-400"></i>
                      </div>
                      <div>
                        <h2 class="text-lg font-semibold text-gray-100">Content Settings</h2>
                        <p class="text-sm text-gray-400">Configure the parameters for your bulk WordPress content generation</p>
                      </div>
                    </div>
                    <%= link_to new_app_prompt_path(target: 'wordpress'), 
                        class: "text-sm text-yellow-400 hover:text-yellow-300 transition-colors",
                        data: { turbo_frame: "prompt_form" } do %>
                      <i data-lucide="plus" class="h-4 w-4 inline mr-1"></i>
                      Create New Prompt
                    <% end %>
                  </div>
                </div>
                
                <div class="p-6 space-y-6">
                  <!-- AI Model Selection -->
                  <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">AI Model</label>
                    <%= f.select :ai_model, grouped_options_for_select(@model_groups, @selected_ai_model), { include_blank: "Select Model" }, { 
                        data: { controller: "choices-select" },
                        class: "block w-full px-4 py-3 rounded-lg bg-[#0F172A]/70 border border-yellow-500/30 text-gray-100 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all duration-200"
                    } %>
                    <p class="-mt-4 text-sm text-gray-400">The AI model to use for generating the content.</p>
                  </div>

                  <div class="p-6 border-t border-gray-600/30">
                  <%= turbo_frame_tag "prompt_form" do %>
                    <!-- replaced by prompt new/edit -->
                  <% end %>

                  <% prompts = Current.user.prompts.enabled.where(target: 'wordpress') %>
                  <% if prompts.any? %>
                    <%= turbo_frame_tag "prompt_selection" do %>
                      <div class="space-y-3">
                        <% prompts.each do |prompt| %>
                          <div class="relative">
                            <input type="radio" name="prompt_id" value="<%= prompt.id %>" id="prompt_<%= prompt.id %>" class="peer sr-only" <%= 'checked' if defined?(@selected_prompt_id) && @selected_prompt_id.to_i == prompt.id %>>
                            <label for="prompt_<%= prompt.id %>" class="flex p-4 border-2 border-yellow-500/30 rounded-lg cursor-pointer transition-all hover:border-yellow-500/50 peer-checked:border-yellow-500 peer-checked:bg-yellow-500/10 peer-checked:shadow-[0_0_15px_rgba(234,179,8,0.2)]">
                              <div class="flex-grow">
                                <div class="flex items-center justify-between mb-2">
                                  <div class="text-sm font-medium text-gray-300">WordPress Prompt</div>
                                  <div class="flex items-center space-x-2">
                                    <%= link_to edit_app_prompt_path(prompt), 
                                        class: "text-yellow-400 hover:text-yellow-300 transition-colors",
                                        data: { turbo_frame: "prompt_form" }, title: "Edit" do %>
                                      <i data-lucide="edit" class="h-4 w-4"></i>
                                    <% end %>
                                    <%= link_to disable_app_prompt_path(prompt), 
                                        method: :patch,
                                        class: "text-red-400 hover:text-red-300 transition-colors",
                                        title: "Disable",
                                        data: { 
                                          confirm: "Are you sure you want to disable this prompt? This action cannot be undone.",
                                          turbo_method: :patch
                                        } do %>
                                      <i data-lucide="x-circle" class="h-4 w-4"></i>
                                    <% end %>
                                  </div>
                                </div>
                                <div class="text-xs text-green-400 font-medium mb-1">USER PROMPT</div>
                                <div class="text-sm text-gray-400 mb-2"><%= truncate(prompt.user_prompt, length: 120) %></div>
                                <div class="text-xs text-purple-400 font-medium mb-1">SYSTEM PROMPT</div>
                                <div class="text-sm text-gray-400"><%= truncate(prompt.system_prompt, length: 100) %></div>
                              </div>
                            </label>
                          </div>
                        <% end %>
                      </div>
                    <% end %>
                  <% else %>
                    <%= turbo_frame_tag "prompt_selection" do %>
                      <div class="text-center py-6 border-2 border-dashed border-yellow-500/30 rounded-lg">
                        <i data-lucide="message-square" class="h-8 w-8 text-yellow-400 mx-auto mb-2"></i>
                        <p class="text-gray-400 text-sm">No WordPress prompts found</p>
                        <p class="text-gray-500 text-xs mt-1">Create a prompt to customize AI content generation</p>
                      </div>
                    <% end %>
                  <% end %>
                </div>

                  <!-- CTA URL Field -->
                  <div>
                    <div class="flex items-center justify-between mb-2">
                      <label class="block text-sm font-medium text-gray-300">Call-to-Action URL</label>
                    </div>

                    <!-- Turbo Frame for domain creation -->
                    <%= turbo_frame_tag "bulk_domain_form" do %>
                      <!-- This will be replaced when creating domains -->
                    <% end %>

                    <!-- Quick Domain Selection -->
                    <% if Current.user.domains.any? %>
                      <div class="mb-3">
                        <p class="text-xs text-gray-400 mb-2">Quick select from your domains:</p>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
                          <% Current.user.domains.each do |domain| %>
                            <button type="button" 
                                    onclick="document.querySelector('input[name=&quot;cta_url&quot;]').value = 'https://<%= domain.name %>/'; document.querySelector('input[name=&quot;cta_url&quot;]').focus();"
                                    class="px-3 py-2 text-xs bg-yellow-500/10 border border-yellow-500/30 rounded text-yellow-300 hover:bg-yellow-500/20 hover:border-yellow-500/50 transition-colors">
                              <i data-lucide="globe" class="h-3 w-3 inline mr-1"></i>
                              <%= domain.name %>
                            </button>
                          <% end %>
                        </div>
                      </div>
                    <% end %>

                    <input type="url" name="cta_url" placeholder="https://yourwebsite.com/product" value="<%= @selected_cta_url %>" required class="block w-full px-4 py-3 rounded-lg bg-[#0F172A]/70 border border-yellow-500/30 text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all duration-200" />
                    <p class="mt-1 text-sm text-gray-400">
                      <% if Current.user.domains.any? %>
                        Click a domain button above to auto-fill, or enter any URL manually.
                      <% else %>
                        The URL where you want to drive traffic. AI will naturally incorporate this into each generated post.
                      <% end %>
                    </p>
                  </div>

                  <!-- WordPress Website Selection -->
                  <div>
                    <label class="block text-sm font-medium text-gray-300 mb-2">WordPress Website</label>
                    <%= f.select :wordpress_website_id, options_for_select(Current.user.wordpress_websites.map { |w| [w.url, w.id] }, @selected_wordpress_website_id), { include_blank: "Select Website" }, { 
                        class: "block w-full px-4 py-3 rounded-lg bg-[#0F172A]/70 border border-yellow-500/30 text-gray-100 focus:outline-none focus:ring-2 focus:ring-yellow-500 focus:border-transparent transition-all duration-200"
                    } %>
                    <p class="mt-1 text-sm text-gray-400">The WordPress website where the generated content will be published.</p>

                    <!-- WordPress Info -->
                    <div class="mt-3 flex items-center p-3 bg-green-500/10 border border-green-500/30 rounded-lg">
                      <i data-lucide="globe" class="h-4 w-4 text-green-400 mr-3 flex-shrink-0"></i>
                      <div class="text-sm">
                        <p class="font-medium text-green-300">WordPress Integration</p>
                        <% if Current.user.wordpress_websites.empty? %>
                          <p class="text-green-200">
                            <%= link_to "Connect a WordPress website", new_app_wordpress_website_path, class: "underline hover:no-underline" %> to publish content
                          </p>
                        <% else %>
                          <p class="text-green-200"><%= pluralize(Current.user.wordpress_websites.count, 'website') %> connected</p>
                        <% end %>
                      </div>
                    </div>
                  </div>
                </div>

              </div>


              <!-- Action Buttons -->
              <div class="bg-[#1E293B]/80 backdrop-blur-sm border border-gray-500/20 rounded-xl p-6">
                <div class="flex items-center justify-between">
                  <div class="flex space-x-3" id="action-buttons">
                    <%= f.submit "Generate WordPress Content", 
                        class: "px-6 py-3 bg-gradient-to-r from-yellow-500 to-red-500 hover:from-yellow-600 hover:to-red-600 text-white rounded-lg font-semibold transition-all duration-200 hover:shadow-[0_0_20px_rgba(234,179,8,0.3)] hover:scale-105 inline-flex items-center",
                        data: { bulk_generation_target: "submit" } do %>
                      <i data-lucide="sparkles" class="h-4 w-4 mr-2"></i>
                      Generate WordPress Content
                    <% end %>
                    <%= link_to "Cancel", app_root_path, 
                        class: "px-6 py-3 bg-transparent border-2 border-gray-500/30 rounded-lg font-semibold transition-all duration-200 hover:border-gray-400/50 hover:bg-gray-500/10 text-gray-300 hover:text-white" %>
                  </div>
                  
                  <div class="flex space-x-3">
                    <!-- Processing Time -->
                    <div class="hidden md:flex items-center space-x-2 text-sm text-gray-400 px-4 py-3">
                      <i data-lucide="clock" class="h-4 w-4"></i>
                      <span>~30 seconds</span>
                    </div>
                    
                    <%= link_to app_keywords_path, 
                        class: "px-4 py-3 bg-gradient-to-r from-gray-600 to-gray-700 hover:from-gray-700 hover:to-gray-800 text-white rounded-lg transition-all duration-200 text-sm font-medium inline-flex items-center shadow-lg" do %>
                      <i data-lucide="list" class="h-4 w-4 mr-2"></i>All Keywords
                    <% end %>
                  </div>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </section>
  </main>
</div>

<script>
// Initialize Lucide icons
if (window.lucide) lucide.createIcons();

// Form validation - ensure prompt is selected and keywords are selected before submission
document.addEventListener('turbo:load', function() {
  const mainForm = document.querySelector('form[data-controller="bulk-generation"]');
  if (mainForm) {
    mainForm.addEventListener('submit', function(e) {
      const selectedPromptId = document.querySelector('input[name="prompt_id"]:checked');
      const selectedKeywords = document.querySelectorAll('input[name="keyword_ids[]"]:checked');
      
      if (!selectedPromptId) {
        e.preventDefault();
        alert('Please select or create a prompt before generating content.');
        return false;
      }
      
      if (selectedKeywords.length === 0) {
        e.preventDefault();
        alert('Please select at least one keyword to generate content for.');
        return false;
      }
    });
  }

  // Re-initialize Lucide icons after Turbo Stream updates
  document.addEventListener('turbo:frame-load', function() {
    if (window.lucide) {
      lucide.createIcons();
    }
  });
});
</script> 